#!/usr/bin/env bash

url="${1:-$(printf "%s" | dmenu -p 'Paste url or file path')}"
IFS=$'\n' readarray -t url_title_name <<< "$(yt-dlp --get-filename -f bestaudio --get-url --get-title -o "%(title)s.%(ext)s" "$url")"

[ "${#url_title_name[1]}" -eq 0 ] && exit 1

title="${url_title_name[0]}"
audio="${url_title_name[1]}"

# Save metadata for later use
history="~/.cache/ytmpc-history"
! grep -q "$url" "$history" && printf "\n%s ; %s" "$url" "$title" >> "$history"

# add the track to mpd and play

mpc --wait stop&&  mpc clear && mpc add "$audio" && mpc play
# mpc update "$(mpc current -f %file%)" title "$title"

# Get YouTube video title for system notification
notify-send "Playing:" "$title" #-i "$(yt-dlp --get-thumbnail <url> --skip-download)"
