#!/bin/sh

permanentdir="$XDG_PICTURES_DIR/screenshots"
tmpdir="/tmp/screenshots"

mkdir -p "$tmpdir"

output="$tmpdir/$(date '+%y-%m-%d_%H:%M:%S').png"

maimsel="maim -u -s"
maimwin="maim -q -u -d 0.2 -i $(xdotool getactivewindow)"
maimful="maim -q -u -d 0.2"

copy () {
    xclip -sel clip -t image/png
}

copy_path () {
    echo "$output" | tr -d '\n' | xclip -sel c -i
}

copied () {
    notify-send -t 1000 "Screenshot has been copied successfully"
}


move () {
    newpath="$(find "$permanentdir" -maxdepth 1 -type d | dmenu -i -l 5 -p "Quit if you want to keep the screenshot in $tmpdir:")"
    mv "$output" "$newpath"
}


usage () {
    echo "Usage:
    -t save to $tmpdir instead of $permanentdir folder
    -s selected area
    -w window
    -f fullscreen
    -c [s, w, f] capture as previous but copy to clipboard instead of saving"
}

while getopts 'cswf' opt; do
    case "$opt" in
    c) toclipboard=true;;
    s) if [ "$toclipboard" = true ]; then
            $maimsel | copy && copied
        else
            $maimsel "${output}" pic-selected- && move ; copy_path
        fi ;;
    w) if [ "$toclipboard" = true ]; then
        $maimwin| copy && copied
        else
            $maimwin "${output}" pic-window- && move ; copy_path
        fi;;
    f) if [ "$toclipboard" = true ]; then
            $maimful | copy && copied
        else
            $maimful "${output}" pic-full- && move ; copy_path
        fi;;
    # F)
        # if [ "$toclipboard" = true ]; then
        # freeze c;;
        # freeze && success;;
    h) usage ;;
    \?) usage; exit 1 ;;
    esac
done

# freeze() {
#     # take screenshot without cursor and pipe to nsxiv, get its pid
#     maim -u | nsxivpipe
#     nsxiv_pid=$!

#     # wait for nsxiv to start
#     while [ -z "$(xdotool search --pid "$nsxiv_pid")" ]; do
#         sleep 0.1
#     done

#     # get window ID of nsxiv
#     wid="$(xdotool search --pid "$nsxiv_pid")"

#     # fullscreen nsxiv and move top-left (works with multi-monitor)
#     xdotool windowsize "$wid" 100% 100%
#     xdotool windowmove "$wid" 0 0

#     # take the new screenshot by selection, pipe to clipboard
#     if [ "$1" = "c" ]; then
#         maim -s | xclip -selection clipboard -t image/png
#     else
#         maim -u -s "${output}" pic-selected-
#     fi

#     # kill nsxiv
#     kill "$nsxiv_pid"
# }
